// Test for verifier contract
#[test_only]
module contracts::verifier_tests {
    use std::string::{Self, String};
    use sui::test_scenario::{Self as ts, ctx};
    use sui::groth16;
    use contracts::verifier::{Self, Vk};
    use sui::groth16::bn254;
    use std::unit_test::assert_eq;
    use std::debug::print;

    const ADMIN: address = @0xA11CE;
    const USER: address = @0xB0B;

  
    #[test]
    fun test_verify_proof() {
        let mut scenario = ts::begin(ADMIN);



        ts::next_tx(&mut scenario, USER);
        {
            let vk_str = vector[226, 242, 109, 190, 162, 153, 245, 34, 59, 100, 108, 177, 251, 51, 234, 219, 5, 157, 148, 7, 85, 157, 116, 65, 223, 217, 2, 227, 167, 154, 77, 45, 171, 183, 61, 193, 127, 188, 19, 2, 30, 36, 113, 224, 192, 139, 214, 125, 132, 1, 245, 43, 115, 214, 208, 116, 131, 121, 76, 173, 71, 120, 24, 14, 12, 6, 243, 59, 188, 76, 121, 169, 202, 222, 242, 83, 166, 128, 132, 211, 130, 241, 119, 136, 248, 133, 201, 175, 209, 118, 247, 203, 47, 3,103, 137, 237, 246, 146, 217, 92, 189, 222, 70, 221, 218, 94, 247, 212, 34, 67, 103, 121, 68, 92, 94, 102, 0, 106, 66, 118, 30, 31, 18, 239, 222, 0, 24, 194, 18, 243, 174, 183, 133, 228, 151, 18, 231, 169, 53, 51, 73, 170, 241, 37, 93, 251, 49, 183, 191, 96, 114, 58, 72, 13, 146, 147, 147, 142, 25, 237, 246, 146, 217, 92, 189, 222, 70, 221, 218, 94, 247, 212, 34, 67, 103, 121, 68, 92, 94, 102, 0, 106, 66, 118, 30, 31, 18, 239, 222, 0, 24, 194, 18, 243, 174, 183, 133, 228, 151, 18, 231, 169, 53, 51, 73, 170, 241, 37, 93, 251, 49, 183, 191, 96, 114, 58, 72, 13, 146, 147, 147, 142, 25, 4, 0, 0, 0, 0, 0, 0, 0, 10, 244, 9, 125, 20, 228, 192, 145, 84, 44, 95, 70, 82, 34, 53, 220, 31, 56, 214, 21, 92, 143, 229, 32, 130, 35, 79, 245, 48, 22, 208, 147, 0, 12, 26, 122, 188, 49, 140, 136, 104, 97, 0, 89, 174, 251, 193, 219, 215, 193, 215, 204, 131, 173, 163, 105, 2, 180, 229, 96, 179, 212, 246, 14, 237, 8, 201, 27, 107, 254, 41, 253, 30, 222, 96, 99, 165, 139, 179, 1, 23, 231, 248, 85, 22, 113, 106, 181, 228, 157, 232, 97, 250, 31, 120, 141, 145, 42, 240, 239, 200, 224, 255, 253, 147, 235, 40, 34, 188, 239, 74, 42, 99, 143, 71, 124, 61,68, 98, 102, 211, 125, 160, 35, 252, 168, 45, 39];
            let vk = groth16::prepare_verifying_key(&bn254(), &vk_str);
            print(&vk);
            let proof_points  = vector[236,121,227,48,224,150,102,241,51,153,247,125,203,156,241,83,242,120,178,36,151,232,120,234,242,200,241,88,206,203,5,136,138,11,41,9,37,185,173,115,181,132,228,2,121,40,195,239,249,29,245,37,61,221,118,226,51,206,47,164,71,171,240,42,224,58,0,214,208,40,26,27,177,174,214,176,20,217,147,120,151,176,82,188,159,15,81,70,125,153,209,182,210,213,48,24,14,158,230,191,242,252,97,226,205,100,116,163,5,109,146,161,236,164,75,91,108,66,186,154,181,14,208,61,170,173,56,41];

            let public_inputs  = vector[136,71,141,72,97,77,2,36,220,182,178,32,161,91,132,227,64,197,207,240,19,155,232,169,229,16,113,220,119,199,169,14,10,141,183,230,9,43,157,135,139,170,6,82,100,146,23,119,39,163,167,40,198,243,117,163,57,117,134,102,126,165,162,3,214,109,34,57,66,238,220,205,134,30,136,234,99,118,137,232,167,133,165,115,113,107,51,197,18,244,20,152,187,236,147,186];

            let proof_points = groth16::proof_points_from_bytes(proof_points);
            print(&proof_points);
            let public_inputs = groth16::public_proof_inputs_from_bytes(public_inputs);
            assert_eq!(sui::groth16::verify_groth16_proof(
                &bn254(),
                &vk,
                &public_inputs,
                &proof_points
            ), true);
            
        };
        
        ts::end(scenario);
    }


    #[test]
    fun test_verifier() {
        let mut scenario = ts::begin(ADMIN);

        let empty_vk = x"e2f26dbea299f5223b646cb1fb33eadb059d9407559d7441dfd902e3a79a4d2dabb73dc17fbc13021e2471e0c08bd67d8401f52b73d6d07483794cad4778180e0c06f33bbc4c79a9cadef253a68084d382f17788f885c9afd176f7cb2f036789edf692d95cbdde46ddda5ef7d422436779445c5e66006a42761e1f12efde0018c212f3aeb785e49712e7a9353349aaf1255dfb31b7bf60723a480d9293938e19edf692d95cbdde46ddda5ef7d422436779445c5e66006a42761e1f12efde0018c212f3aeb785e49712e7a9353349aaf1255dfb31b7bf60723a480d9293938e1904000000000000000af4097d14e4c091542c5f46522235dc1f38d6155c8fe52082234ff53016d093000c1a7abc318c8868610059aefbc1dbd7c1d7cc83ada36902b4e560b3d4f60eed08c91b6bfe29fd1ede6063a58bb30117e7f85516716ab5e49de861fa1f788d912af0efc8e0fffd93eb2822bcef4a2a638f477c3d446266d37da023fca82d27";
        let empty_proof = x"c22d229a425356e7275caf981461a251fc375d7cfd60d9a1b8b2d99cc451c9a1da14ccec96be869eba1132d03ccd97d2d40c82beab7d10a27e4801334ce87c031c876a049f44f2fe35c3e23b883aa2b1dc097f1bc5c42f601ebf4017a03e13216e9dd3dbe98cc3ddf67ce65311695d6f6ae527a6a078c6f38de6c167f732ca09";
        let empty_inputs = x"88478d48614d0224dcb6b220a15b84e340c5cff0139be8a9e51071dc77c7a90e0a8db7e6092b9d878baa06526492177727a3a728c6f375a3397586667ea5a2032237715302188883a465c66568131dc3047a2d54000000000000000000000000";

        ts::next_tx(&mut scenario, ADMIN);
        {
            verifier::create_vk( empty_vk, ctx(&mut scenario));
        };

        ts::next_tx(&mut scenario, USER);
        {
            let vk = ts::take_shared<Vk>(&scenario);
            
            verifier::verify_zeroleaks_proof(
                &vk,
                empty_proof,
                empty_inputs,
                ctx(&mut scenario)
            );
            
            ts::return_shared(vk);
        };

        ts::end(scenario);
    }

}
